name: Flutter CI/CD Pipeline
on:
  push:
    branches: [ main ]
  pull_request:
    # Triggers on PRs against main to validate code before merge
    branches: [ main ]

jobs:
  build_apk:
    runs-on: ubuntu-latest 
    steps:
      - name: 📦 Checkout Repository
        uses: actions/checkout@v4

      - name: ☕ Set up Java Development Kit (JDK 17)
        # Required for building Android apps using Gradle
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 🛠️ Install Android SDK Components and Accept Licenses
        # This step installs the required NDK, Build Tools, and Platform SDK
        # to prevent Gradle from failing during the build phase.
        run: |
          yes | sdkmanager --licenses
          # Install a recent, stable NDK (Version 26)
          sdkmanager "ndk;26.1.10909125"
          # Install the latest Platform SDK and Build Tools
          sdkmanager "platforms;android-34" "build-tools;34.0.0"

      - name: 🐦 Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          # Using 'stable' ensures you always use the latest stable version
          flutter-version: 'stable'

      - name: ⚙️ Install Dependencies
        run: flutter pub get

      - name: 🔬 Run Code Analysis (Linting)
        # Check for errors and warnings before building
        run: flutter analyze

      - name: 🧪 Run Unit and Widget Tests
        # Ensure all tests pass before continuing to the build
        run: flutter test

      - name: 🏗️ Build Release APK
        run: flutter build apk --release

      - name: 💾 Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          # Using a wildcard ensures the correct file is picked up, even if the name changes (e.g., debug vs. release)
          path: build/app/outputs/flutter-apk/*.apk
          # Configure retention to save space (e.g., keep the artifact for 5 days)
          retention-days: 5
